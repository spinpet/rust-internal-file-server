---
name: rust-internal-file-server
status: backlog
created: 2025-09-04T23:25:11Z
progress: 0%
prd: .claude/prds/rust-internal-file-server.md
github: https://github.com/spinpet/rust-internal-file-server/issues/1
---

# Epic: Rust内网文件服务器

## 概述

构建一个基于Rust的高性能内网文件服务器，支持匿名访问、大文件传输和在线视频播放。采用Axum+Tokio后端和原生前端技术栈，确保简洁高效的实现。

## 架构决策

### 核心技术选择
- **后端框架**: Axum - 高性能、类型安全、中间件友好
- **异步运行时**: Tokio - 成熟的异步生态，支持高并发
- **数据库**: SQLite - 轻量级，无需额外配置，适合元数据存储
- **前端**: 原生Web技术 - 避免框架复杂性，减少依赖

### 设计模式
- **模块化设计**: 按功能模块组织代码（上传、下载、播放、UI）
- **异步优先**: 所有I/O操作使用异步模式
- **流式处理**: 大文件分块传输，避免内存问题
- **REST API**: 简洁的API设计，易于前端集成

## 技术实现

### 后端服务
**核心模块**
- `server.rs` - Axum路由和中间件配置
- `storage.rs` - 文件存储和元数据管理
- `upload.rs` - 分块上传和断点续传
- `download.rs` - 流式下载和Range请求
- `video.rs` - 视频元信息和缩略图生成

**数据模型**
```sql
CREATE TABLE files (
    id INTEGER PRIMARY KEY,
    filename TEXT NOT NULL,
    size INTEGER NOT NULL,
    mime_type TEXT,
    upload_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    file_path TEXT NOT NULL
);
```

**API端点**
- `GET /` - 文件列表页面
- `POST /upload` - 文件上传
- `GET /files/:id` - 文件下载
- `DELETE /files/:id` - 文件删除
- `GET /files/:id/info` - 文件信息
- `GET /search` - 文件搜索

### 前端组件
**页面结构**
- `index.html` - 主文件列表页
- `upload.html` - 上传页面
- `player.html` - 视频播放器
- `styles.css` - 现代UI样式
- `app.js` - 核心交互逻辑

**核心功能**
- 拖拽上传界面
- 实时进度显示
- 响应式文件网格
- 内置视频播放器
- 搜索和过滤

### 基础设施
**部署考虑**
- 单体应用部署，简化运维
- 配置文件支持端口、存储路径等设置
- 系统服务集成（systemd/windows service）

**性能优化**
- 静态文件缓存
- 连接池管理
- 异步文件I/O
- HTTP/2支持

## 实现策略

### 开发阶段
1. **MVP核心** - 基础上传下载功能
2. **视频支持** - 播放器和格式支持
3. **用户体验** - 界面优化和交互完善

### 风险控制
- 文件大小限制配置
- 存储空间监控
- 错误恢复机制
- 浏览器兼容性测试

### 测试方法
- 单元测试覆盖核心逻辑
- 集成测试验证API功能
- 压力测试确保并发性能
- 手动测试验证用户体验

## 任务分解

### 创建的任务列表
- [ ] #2 - 项目初始化和基础架构 (parallel: true, 2-3小时)
- [ ] #3 - 数据库和存储模块 (parallel: false, 4-6小时)
- [ ] #4 - 核心Web服务器 (parallel: false, 3-5小时)
- [ ] #5 - 文件上传API和功能 (parallel: true, 6-8小时)
- [ ] #6 - 文件下载和管理API (parallel: true, 6-8小时)
- [ ] #7 - 视频处理和播放功能 (parallel: true, 8-12小时)
- [ ] #8 - 前端用户界面开发 (parallel: false, 12-16小时)
- [ ] #9 - 测试和部署配置 (parallel: false, 6-8小时)

### 任务统计
- **总任务数**: 8个
- **并行任务**: 4个 (#2, #5, #6, #7)
- **串行任务**: 4个 (#3, #4, #8, #9)
- **预估总工时**: 47-68小时
- **关键依赖链**: #2→#3→#4→(#5,#6,#7)→#8→#9

### 执行策略
**第一阶段**: 任务#2（并行启动）
**第二阶段**: 任务#3→#4（串行执行）
**第三阶段**: 任务#5、#6、#7（并行开发，注意#6与#5有文件冲突）
**第四阶段**: 任务#8（需要所有后端API完成）
**第五阶段**: 任务#9（最终测试和部署）
## 依赖项

### 外部依赖
- **FFmpeg**: 视频处理和缩略图生成
- **Web浏览器**: Chrome 90+, Firefox 88+, Safari 14+

### 内部依赖
- **Rust工具链**: 1.70+版本
- **系统权限**: 文件读写和端口绑定权限

### 先决工作
- 确定服务器硬件配置
- 规划存储目录结构
- 配置防火墙和网络访问

## 成功标准（技术）

### 性能基准
- **并发用户**: 100+用户同时访问无性能下降
- **文件大小**: 支持10GB单文件上传下载
- **响应时间**: API响应 < 100ms，页面加载 < 2秒
- **吞吐量**: 内网环境下充分利用带宽

### 质量关卡
- **代码覆盖率**: 核心功能 > 80%测试覆盖
- **错误处理**: 所有异常情况有适当处理
- **内存安全**: 无内存泄漏和悬挂指针
- **文件完整性**: 上传下载文件MD5校验

### 验收标准
- 支持Chrome、Firefox、Safari浏览器
- 拖拽上传10MB-10GB文件正常
- 视频文件在线播放流畅
- 界面在不同屏幕尺寸下正常显示

## 工作量估算

### 总体时间线
- **整体开发**: 4-6周
- **MVP版本**: 2周
- **完整功能**: 4周
- **测试优化**: 1-2周

### 资源需求
- **开发人员**: 1-2名Rust开发者
- **测试环境**: 内网服务器和多个测试客户端
- **存储需求**: 根据团队文件量确定

### 关键路径
1. 存储模块和上传下载API（核心功能基础）
2. 前端界面开发（用户体验关键）
3. 视频播放功能（差异化特性）
4. 性能测试和优化（质量保证）

